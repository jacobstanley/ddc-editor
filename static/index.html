<html>
  <head>
    <title>DDC Core Flow</title>
    <link rel="stylesheet" href="css/reset.css"/>
    <link rel="stylesheet" href="codemirror/codemirror.css"/>
    <link rel="stylesheet" href="css/jellybeans.css"/>
    <link rel="stylesheet" href="css/screen.css"/>
  </head>
  <body>
    <div style="width: 50%; float: left;">
<textarea id="code" name="code">
module Main

export {
    main : Unit -&gt; Unit;
}

import type {
    rT : Region;
}

import foreign c value {
    showInt  : Int# -&gt; Ptr# rT String#;
    showNat  : Nat# -&gt; Ptr# rT String#;
    putStrLn : Ptr# rT String# -&gt; Unit;
}
with letrec

external (vs : Vector# Nat#)
 = vs

test    (sz : Nat#)
 = do   xs  = vgenerate# sz (add# 1#)
        xs' = external xs
        y   = vreduce# add# 0# xs'
        ys  = vfilter# (lt# 5#) xs'
        z   = vreduce# add# y ys
        T2# z ys

main    (_ : Unit)
 = do   res = test 10#
        case res of
            T2# i v
             -&gt; do putStrLn (showNat i)
                   putStrLn (showNat (vlength# v))
        ()
</textarea>
    </div>
    <div style="width: 50%; float: right">
      <div id="ddc-results" class="ddc-results">
      </div>
    </div>
  </body>
  <script src="codemirror/codemirror.js"></script>
  <script src="codemirror/keymap/vim.js"></script>
  <script src="js/ddc-core.js"></script>
  <script>
    function betterTab(cm) {
      if (cm.somethingSelected()) {
        cm.indentSelection("add");
        } else {
        cm.replaceSelection(
          cm.getOption("indentWithTabs") ? "\t" : Array(cm.getOption("indentUnit") + 1).join(" "), "end", "+input");
      }
    }

    var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
      mode: "text/x-ddc-core",
      lineNumbers: true,
      matchBrackets: true,
      styleActiveLine: true,
      showCursorWhenSelecting: true,
      tabSize: 8,
      indentUnit: 4,
      indentWithTabs: false,
      extraKeys: { Tab: betterTab }
    });

    editor.setOption("theme", "jellybeans");
    editor.setOption("vimMode", true);

    var check = function() {
      var code    = editor.getValue();
      var results = document.getElementById("ddc-results");

      var request = new XMLHttpRequest();
      request.open('POST', '/check', true);
      request.onload  = function() { results.textContent = this.response; };
      request.onerror = function() { results.textContent = "an unknown error occurred" };
      request.setRequestHeader('Content-Type', 'text/x-ddc-core; charset=UTF-8');
      request.send(code);
    };

    CodeMirror.on(editor, "changes", function(args) {
      check();
    });

    check();
  </script>
</html>
